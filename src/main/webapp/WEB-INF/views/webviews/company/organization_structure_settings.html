<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>上海元升财务咨询有限公司</title>
<link rel="stylesheet" type="text/css" href="/css/webcss/bui.css">
<link rel="stylesheet" type="text/css" href="/css/webcss/golbal.css">
<link rel="stylesheet" type="text/css" href="/css/webcss/layout.css">
<link rel="stylesheet" type="text/css" href="/css/webcss/zTreeStyle.css">
<style type="text/css">
.ztree li span.button.add {
	margin-left: 2px;
	margin-right: -1px;
	background-position: -144px 0;
	vertical-align: top;
	*vertical-align: middle
}
</style>
</head>
<body>
	<div class="wrap">
		<div class="side-bar">
			<div class="side-bar-top">
				<img src="/img/webimg/bss-logo.png">
				<h1>上海元升财务咨询有限公司</h1>
			</div>
			<div class="side-bar-content"  id="menuTree"></div>
			<div class="side-bar-bottom">
				<ul>
					<li><a href="javascript:void(0);" id="setPwd"><i class="setting"></i>设置</a></li>
					<li><a href="/logout"><i class="exit"></i>安全退出</a></li>
				</ul>
			</div>
		</div>
		<div class="main">
			<div class="framework">
				<table class="table table-bordered">
					<colgroup>
						<col style="width: 220px; background: #fafafa; overflow: hidden;">
						<col>
					</colgroup>
					<tr>
						<td>
							<div class="fk-tree">
								<h2>组织架构</h2>
								<ul id="t1" class="ztree"></ul>
							</div>
						</td>
						<td>
							<div class="fk-content">
								<div class="menu">
									<a href="" class="active">当前组织架构信息</a>
								</div>
								<div class="fk-content-info">
									<div class="form-horizontal onlineTools">
										<div class="row-fluid show-grid">
											<div class="span12">
												<label>公司名称：</label><span id="company_name"
													class="detail-text"></span>
											</div>
											<div class="span12">
												<label>上级组织：</label><span id="parent_company"
													class="detail-text"></span>
											</div>
										</div>
										<div class="row-fluid show-grid">
											<div class="span12">
												<label>组织名称：</label><span id="org_name" class="detail-text"></span>
											</div>
											<div class="span12">
												<label>组织代码：</label><span id="org_code" class="detail-text"></span>
											</div>
										</div>
										<div class="row-fluid show-grid">
											<div class="span12">
												<label>组织类型：</label><span id="org_type" class="detail-text"></span>
											</div>
											<div class="span12" style="display:none;">
                                                <label>微信邀请码：</label><span id="org_weixin_code" class="detail-text"></span>
                                            </div>
										</div>
									</div>
									<div class="panel mt10">
										<div class="panel-header"
											style="color: #5da09a; font-weight: bold; font-size: 14px;">当前可以进行的操作</div>
										<div class="panel-body well" style="height: 150px;">
											<div id="addOneLevelDeptOrSubCompany" style="display: none;">
												<div style="margin-bottom:10px;">
													<p class="mt10">
														<label for="">您当前选择的是：</label><input style="margin-left:25px;" type="text" class="input input-normal" id="currentSelectSubComapny" disabled>
														<button id="deleteSubCompany" class="button button-danger ml10" style="width:110px;">删除子公司</button>
													</p>
												</div>
												<div>
													<label for="">您可以添加一级部门：</label> <select
														class="input input-normal" id="oneLevelDeptSelect"
														style="width: 160px;"></select>
													<button id="addNewOneLevelDept"
														class="button button-success ml10" style="width:110px;">确定添加</button>
												</div>
												<div>
													<p class="mt10">
														<label for="">您可以添加子公司：</label><input type="text"
															id="newSubCompanyName" class="input input-normal"
															style="margin-left: 15px;">
														<button id="addNewSubComapny"
															class="button button-success ml10" style="width:110px;">确定添加</button>
													</p>
												</div>
											</div>
											<div id="addSubDept" style="display: none;">
												<p class="mt10">
													<label for="">您当前选择的部门是：</label><input type="text" class="input input-normal" id="currentSelectDept" disabled>
													<a href="javascript:void(0);" id="deleteDept" class="button button-danger ml10">删除部门</a>
												</p>
												<p class="mt10">
													<label for="">您可以修改部门名称：</label><input id="newModifyDeptName"
														type="text" class="input input-normal">
													<button id="modifyDeptName" class="button button-success ml10">确定修改</button>
												</p>
												<p class="mt10">
													<label for="">您可以增加子部门：</label><input id="newDeptName"
														type="text" class="input input-normal" style="margin-left:12px;">
													<button id="addNewDept" class="button button-success ml10">确定添加</button>
												</p>
											</div>
											<div style="margin-top: 20px;">
												<div id="currentOpeTips" class="tips tips-warning"
													style="display: none;"></div>
												<div id="currentTips" class="tips tips-success"
													style="display: none;"></div>
											</div>
										</div>
									</div>
								</div>

							</div>
						</td>
					</tr>
				</table>
			</div>
			<div class="panel mt20">
				<div class="panel-header">
					组织成员
					<button id="addDeptUser"
						class="fr mtt5 button button-success button-small disabled">添加员工</button>
				</div>
				<div class="panel-body" style="min-height: 300px;">
					<table class="table table-bordered table-head-bordered center">
						<colgroup>
							<col style="width: 13%;">
							<col style="width: 13%;">
							<col style="width: 13%;">
							<col style="width: 13%;">
							<col style="width: 13%;">
							<col style="width: 10%;">
							<col style="width: 10%;">
							<col style="width: 15%;">
							<col>
						</colgroup>
						<thead>
							<tr>
								<th>员工姓名</th>
								<th>所在部门</th>
								<th>员工编号</th>
								<th>员工职级</th>
								<th>审批人</th>
								<th>微信邀请码</th>
								<th>公司管理员</th>
								<th>操作</th>
							</tr>
						</thead>
						<tbody id="deptUserList">
						</tbody>
					</table>
				</div>
			</div>
		</div>
	</div>

	<div id="addDeptUserForm" style="display:none;">
		<div id="form" class="form-horizontal">
			<div class="control-group">
				<label class="control-label"><s>*</s>电子邮件地址：</label>
				<div class="controls">
					<input id="dept_user_email" type="text" class="input-large"
						data-rules="{required : true}" style="width:250px;">
					<!-- <span class="ml10 text-danger">已被使用，请检查！</span> -->
				</div>
			</div>
			<div class="control-group">
				<label class="control-label"><s>*</s>员工姓名：</label>
				<div class="controls">
					<input type="text" class="input-large" id="dept_user_name"
						data-rules="{required : true}" style="width:250px;">
				</div>
			</div>
			<div class="control-group">
				<label class="control-label"><s>*</s>负责人标示：</label>
				<div class="controls control-row-auto">
					<select class="input input-normal" id="dept_user_is_admin" style="width: 260px;">
						<option value='0'>非部门负责人</option>
						<option value='1'>部门负责人</option>
					</select>
				</div>
			</div>
			<div class="control-group">
				<label class="control-label">所在部门：</label>
				<div class="controls">
					<input type="text" class="input-large" id="dept_user_dept_name"
						data-rules="{required : true}" disabled style="width:250px;">
					<input type="hidden" class="input-large" id="dept_user_dept_id"
						data-rules="{required : true}" disabled style="width:250px;">
				</div>
			</div>
			<div class="control-group">
				<label class="control-label"><s>*</s>员工编号：</label>
				<div class="controls control-row-auto">
					<input type="text" id="dept_user_code" class="input-large" style="width:250px;"></input>
				</div>
			</div>
			<div class="control-group">
				<label class="control-label"><s>*</s>员工职级：</label>
				<div class="controls control-row-auto">
					<input type="text" id="dept_user_level" class="input-large" style="width:250px;"></input>
				</div>
			</div>
			<div class="control-group">
				<label class="control-label">审批人：</label>
				<div class="controls control-row-auto">
					<select class="input input-normal" id="dept_user_audit" style="width: 260px;"></select>
				</div>
			</div>
			<div class="control-group control-btn">
				<div class="layer-wrap-footer"><a href="javascript:void(0);" id="dept_user_submit" class="button button-success">确定添加</a></div>
			</div>
		</div>
	</div>

	<div id="modifyDeptUserForm" style="display:none;">
		<div id="form" class="form-horizontal">
			<div class="control-group">
				<label class="control-label"><s>*</s>电子邮件地址：</label>
				<div class="controls">
					<input id="modify_dept_user_email" type="text" class="input-large"
						data-rules="{required : true}" style="width:250px;" disabled>
					<!-- <span class="ml10 text-danger">已被使用，请检查！</span> -->
				</div>
			</div>
			<div class="control-group">
				<label class="control-label"><s>*</s>员工姓名：</label>
				<div class="controls">
					<input type="text" class="input-large" id="modify_dept_user_name"
						data-rules="{required : true}" style="width:250px;">
				</div>
			</div>
			<div class="control-group">
				<label class="control-label"><s>*</s>负责人标示：</label>
				<div class="controls control-row-auto">
					<select class="input input-normal" id="modify_dept_user_is_admin" style="width: 260px;">
						<option value='0'>非部门负责人</option>
						<option value='1'>部门负责人</option>
					</select>
				</div>
			</div>
			<div class="control-group">
				<label class="control-label">所在部门：</label>
				<div class="controls">
					<input type="text" class="input-large" id="modify_dept_user_dept_name"
						data-rules="{required : true}" disabled style="width:250px;">
					<input type="hidden" class="input-large" id="modify_dept_user_dept_id"
						data-rules="{required : true}" disabled style="width:250px;">
				</div>
			</div>
			<div class="control-group">
				<label class="control-label"><s>*</s>员工编号：</label>
				<div class="controls control-row-auto">
					<input type="text" id="modify_dept_user_code" class="input-large" style="width:250px;"></input>
				</div>
			</div>
			<div class="control-group">
				<label class="control-label"><s>*</s>员工职级：</label>
				<div class="controls control-row-auto">
					<input type="text" id="modify_dept_user_level" class="input-large" style="width:250px;"></input>
				</div>
			</div>
			<div class="control-group">
				<label class="control-label">审批人：</label>
				<div class="controls control-row-auto">
					<select class="input input-normal" id="modify_dept_user_audit" style="width: 260px;"></select>
				</div>
			</div>
			<div class="control-group">
				<label class="control-label">公司管理员：</label>
				<div class="controls control-row-auto">
					<select class="input input-normal" id="modify_user_admin" style="width: 260px;">
						<option value='0'>否</option>
						<option value='1'>是</option>
					</select>
				</div>
			</div>
			<div class="control-group control-btn">
				<div class="layer-wrap-footer"><a href="javascript:void(0);" id="dept_user_modify" class="button button-success">确定修改</a></div>
			</div>
		</div>
	</div>
	<div id="modifyPwd" style="display:none;">
		<div id="form" class="form-horizontal">
			<div class="control-group">
				<label class="control-label">输入旧密码：</label>
				<div class="controls">
					<input id="old_pwd" type="password" class="input-large"
						data-rules="{required : true}" style="width:250px;">
				</div>
			</div>
			<div class="control-group">
				<label class="control-label">输入新密码：</label>
				<div class="controls control-row-auto">
					<input id="new_pwd" type="password" class="input-large"
						data-rules="{required : true}" style="width:250px;">
				</div>
			</div>
			<div class="control-group">
				<label class="control-label">再次输入新密码：</label>
				<div class="controls control-row-auto">
					<input id="confirm_new_pwd" type="password" class="input-large"
						data-rules="{required : true}" style="width:250px;">
				</div>
			</div>
			<div class="control-group">
				<label id="modify_pwd_tips"></label>
			</div>
			<div class="control-group control-btn">
				<div class="layer-wrap-footer"><a href="javascript:void(0);" id="modify_pwd_button" class="button button-success">确定修改</a></div>
			</div>
		</div>
	</div>
	<div style="position:fixed; bottom: 0; right: 0;"><a target="_blank" href="http://sighttp.qq.com/authd?IDKEY=a1a51fb184a88bbb4c1756a211f1ff1fbc9d47079f63eb30"><img border="0" src="http://wpa.qq.com/imgd?IDKEY=a1a51fb184a88bbb4c1756a211f1ff1fbc9d47079f63eb30&pic=41" alt="点我联系我" title="点我联系我"/></a></div>
	<!--该js需要修改js路径及修改seajs路径-->
	<script src="http://g.tbcdn.cn/fi/bui/jquery-1.8.1.min.js"></script>
	<script src="http://g.alicdn.com/bui/seajs/2.3.0/sea.js"></script>
	<script src="http://g.alicdn.com/bui/bui/1.1.17/config.js"></script>
	<script src="/js/webjs/menuTree.js"></script>
	<!--ztree-->
	<!-- <script src="/js/webjs/zTree_v3/jquery.ztree.all-3.5.min.js"></script> -->
	<script type="text/javascript">
	BUI.use(['bui/imgview', 'bui/overlay'], function(Imgview, Overlay){
		var modifyPwdForm = new Overlay.Dialog({
            title:'密码修改',
            width:600,
            height:280,
            contentId:'modifyPwd',
            success:function () {
              	this.close();
            },
            buttons : []
        });
		$('#setPwd').click(function(){
			modifyPwdForm.show();
		})
		$('#modify_pwd_button').click(function(){
			var oldPwd = $('#old_pwd').val();
			var newPwd = $('#new_pwd').val();
			var confirmNewPwd = $('#confirm_new_pwd').val();
			if(oldPwd == null || oldPwd == "") {
				BUI.Message.Alert('请输入旧密码！','warning');
				return;
			}
			if(newPwd == null || newPwd == "") {
				BUI.Message.Alert('请输新密码！','warning');
				return;
			}
			if(confirmNewPwd == null || confirmNewPwd == "") {
				BUI.Message.Alert('请输入新密码！','warning');
				return;
			}
			if(newPwd != confirmNewPwd) {
				BUI.Message.Alert('两次输入的新密码不一致，请检查！','warning');
				return;
			}
			$.ajax({
				url : '/modifyPassword',
				type : "POST",
				data : {oldPwd:oldPwd, newPwd:newPwd},
				success : function(data) {
					if(data.error_code == "0") {
						BUI.Message.Alert('修改密码成功！','success');
					} else {
						BUI.Message.Alert('修改密码失败！错误信息：' + data.error_msg,'warning');
					}
				},
				error : function(data) {
					BUI.Message.Alert('修改密码失败！错误信息：' + data.error_msg,'warning');
				}
			});
		})
	});
	var store = null;
	var tree = null;
	
	//竖状菜单
    var menu = new menuTree(
            {"nodes" : [
{text : '组织架构',id : '50',href:"javascript:void(0);",  expanded : true,children: [
                                                          						{text : '基本信息设置',id : '51', href:"/views/webviews/company/organization_information_settings.html"},
                                                          						{text : '组织架构设置',id : '52', href:"/views/webviews/company/organization_structure_settings.html"}                                           
                                                          					]},
					{text : '公司费用发票',id : '10',href:"javascript:void(0);",  expanded : false,children: [
						{text : '发票上传',id : '11', href:"/views/webviews/company/expense_account_upload.html"},
						{text : '发票历史记录',id : '12', href:"/views/webviews/company/expense_account_history.html"}                                           
					]},
					{text : '银行对账单',id : '20',href:"javascript:void(0);", expanded : false,children: [
						{text : '上传对账单',id : '21', href:"/views/webviews/company/bank_statement_upload.html"},
						{text : '对账单历史记录',id : '22', href:"/views/webviews/company/bank_statement_history.html"},
						{text : '上传回单',id : '21', href:"/views/webviews/company/bank_response_upload.html"},
						{text : '回单历史记录',id : '22', href:"/views/webviews/company/bank_response_history.html"},                                           
					]},
					{text : '销售清单',id : '80',href:"javascript:void(0);", expanded : false,children: [
					                                                         						{text : '上传销售清单',id : '81', href:"/views/webviews/company/sales_upload.html"},
					                                                         						{text : '销售清单历史记录',id : '82', href:"/views/webviews/company/sales_history.html"}                                           
					                                                         					]},
					{text : '工资社保',id : '30',href:"javascript:void(0);", expanded : false,children: [
						
						{text : '下载工资计算模板',id : '32', href:"/views/webviews/company/salary_welfare_template_download.html"},                                           
						{text : '上传工资单',id : '33', href:"/views/webviews/company/salary_welfare_upload.html"},
						{text : '工资历史记录',id : '34', href:"/views/webviews/company/salary_history.html"},
						{text : '工资计算模板历史记录',id : '35', href:"/views/webviews/company/salary_template_history.html"}
					]},
					{text : '预约取发票',id : '40',href:"javascript:void(0);", expanded : false,children: [
						{text : '方式选择',id : '41', href:"/views/webviews/company/take_expense_account_mode_select.html"}                                           
					]},
					
					{text : '基本报表',id : '70',href:"javascript:void(0);",  expanded : false,children: [
					                                                          						{text : '资产负债表',id : '71', href:"/views/webviews/company/sheet_balance.html"},
					                                                          						{text : '利润表',id : '72', href:"/views/webviews/company/sheet_income.html"},
					                                                          						{text : '现金流量表',id : '73', href:"/views/webviews/company/sheet_cash.html"},
					                                                          						{text : '薪酬及税费表',id : '74', href:"/views/webviews/company/sheet_salary.html"},
					                                                          						{text : '下载Excel模板',id : '75', href:"/views/webviews/company/base_statement_template_download.html"}
					                                                          					]},
					{text : '会计点将',id : '60',href:"/views/webviews/company/select_accounter.html",  leaf:false,expanded : false,children: []},
					{text : '申请发票',id : '90',href:"/views/webviews/company/apply_invoice.html",  leaf:false,expanded : false,children: []},
					{text : '查看合同文件',id : '100',href:"/views/webviews/company/contract.html",  leaf:false,expanded : false,children: []},
					]
            },"menuTree"
        );
    defaultSelect("52");
    function defaultSelect(id){ 
        $("#"+id).parent().addClass("bui-menu-item-selected")
    }
	
	
	
    BUI.use(['bui/tree','bui/data','bui/overlay','bui/mask'],function (Tree,Data,Overlay,Mask) {
    	$('#addNewOneLevelDept').click(function(){
    		var oneLevelDeptSelectCostCenterEncode = $('#oneLevelDeptSelect option:selected').val();
    		var oneLevelDeptSelectName = $('#oneLevelDeptSelect option:selected').text();
    		var item = tree.getSelected();
    		var companyId = (item == null || item=='' ? headCompanyId : (item.id == null ? item.companyId : item.id));
    		$.ajax({
        		url : '/company/addDept',
        		type : "POST",
        		data : {deptName:oneLevelDeptSelectName,deptCostEncode:oneLevelDeptSelectCostCenterEncode, curDeptId:0,level:0,companyId:companyId},
        		success : function(data) {
        			if(data == null || data == '' || data.resultCode == null || data.resultCode != '0') {
        				//alert('出错');
        				return;
        			} else {
        				store.load(null);
        				$.ajax({
        		    		url : '/company/getAllUser',
        		    		type : "POST",
        		    		async: false,
        		    		data : {companyId:headCompanyId},
        		    		success : function(data) {
        		    			if(data == null || data == '') return;
        		    			$('#modify_dept_user_audit').append("<option value='0'>默认</option>");
        		    			$('#dept_user_audit').append("<option value='0'>默认</option>");
        		    			for(var i=0; i<data.length; i++) {
        		    				$('#modify_dept_user_audit').append("<option value='"+data[i].userId+"'>" + data[i].name + "</option>");
        		    				$('#dept_user_audit').append("<option value='"+data[i].userId+"'>" + data[i].name + "</option>");
        		    			}
        		    		}
        		    	});
        			}        			
        		}
        	});
    	})
    	$('#addNewSubComapny').click(function(){
    		var newSubCompanyName = $('#newSubCompanyName').val();
    		if(newSubCompanyName == null || newSubCompanyName =='') {
    			BUI.Message.Alert('子公司名称不能为空！','warning');
    			return;
    		}
    		$.ajax({
        		url : '/company/addSubCompany',
        		type : "POST",
        		data : {companyName:newSubCompanyName,curCompanyId:headCompanyId},
        		success : function(data) {
        			if(data == null || data == '' || data.resultCode == null || data.resultCode != '0') {
        				//alert('出错');
        				return;
        			} else {
        				store.load(null);
        				$.ajax({
        		    		url : '/company/getAllUser',
        		    		type : "POST",
        		    		async: false,
        		    		data : {companyId:headCompanyId},
        		    		success : function(data) {
        		    			if(data == null || data == '') return;
        		    			$('#modify_dept_user_audit').append("<option value='0'>默认</option>");
        		    			$('#dept_user_audit').append("<option value='0'>默认</option>");
        		    			for(var i=0; i<data.length; i++) {
        		    				$('#modify_dept_user_audit').append("<option value='"+data[i].userId+"'>" + data[i].name + "</option>");
        		    				$('#dept_user_audit').append("<option value='"+data[i].userId+"'>" + data[i].name + "</option>");
        		    			}
        		    		}
        		    	});
        			}        			
        		}
        	});
    	})
    	$('#deleteSubCompany').click(function(){
    		var item = tree.getSelected();
    		if(!item.leaf) {
    			BUI.Message.Alert('当前子公司具有子部门，请先删除子部门！','warning');
    			return;
    		}
    		$.ajax({
        		url : '/company/delSubCompany',
        		type : "POST",
        		data : {curCompanyId:item.companyId},
        		success : function(data) {
        			if(data == null || data == '' || data.resultCode == null || data.resultCode != '0') {
        				//alert('出错');
        				return;
        			} else {
        				store.load(null);
        				$.ajax({
        		    		url : '/company/getAllUser',
        		    		type : "POST",
        		    		async: false,
        		    		data : {companyId:headCompanyId},
        		    		success : function(data) {
        		    			if(data == null || data == '') return;
        		    			$('#modify_dept_user_audit').append("<option value='0'>默认</option>");
        		    			$('#dept_user_audit').append("<option value='0'>默认</option>");
        		    			for(var i=0; i<data.length; i++) {
        		    				$('#modify_dept_user_audit').append("<option value='"+data[i].userId+"'>" + data[i].name + "</option>");
        		    				$('#dept_user_audit').append("<option value='"+data[i].userId+"'>" + data[i].name + "</option>");
        		    			}
        		    		}
        		    	});
        			}        			
        		}
        	});
    	})
    	$('#addNewDept').click(function(){
    		var newDeptName = $('#newDeptName').val();
    		if(newDeptName == null || newDeptName =='') {
    			BUI.Message.Alert('部门名称不能为空！','warning');
    			return;
    		}
    		var item = tree.getSelected();
    		var companyId = (item == null || item=='' ? headCompanyId : item.companyId);
    		$.ajax({
        		url : '/company/addDept',
        		type : "POST",
        		data : {deptName:newDeptName,parentCostCenterEncode:item.costCenter,curDeptId:item.id,level:item.level,companyId:companyId},
        		success : function(data) {
        			if(data == null || data == '' || data.resultCode == null || data.resultCode != '0') {
        				//alert('出错');
        				return;
        			} else {
        				store.load(null);
        				$.ajax({
        		    		url : '/company/getAllUser',
        		    		type : "POST",
        		    		async: false,
        		    		data : {companyId:headCompanyId},
        		    		success : function(data) {
        		    			if(data == null || data == '') return;
        		    			$('#modify_dept_user_audit').append("<option value='0'>默认</option>");
        		    			$('#dept_user_audit').append("<option value='0'>默认</option>");
        		    			for(var i=0; i<data.length; i++) {
        		    				$('#modify_dept_user_audit').append("<option value='"+data[i].userId+"'>" + data[i].name + "</option>");
        		    				$('#dept_user_audit').append("<option value='"+data[i].userId+"'>" + data[i].name + "</option>");
        		    			}
        		    		}
        		    	});
        			}        			
        		}
        	});
    	})
    	$('#modifyDeptName').click(function(){
    		var item = tree.getSelected();
    		if((item.level != null && item.level == '1') || (item.level != null && item.level == '2' && item.parent.typeIsSubCompany)) {
    			BUI.Message.Alert('一级部门名称不允许修改！','warning');
    			return;
    		} else if($('#newModifyDeptName').val() == null || $('#newModifyDeptName').val() == '') {
    			BUI.Message.Alert('部门名称不能为空！','warning');
    			return;
    		}
    		var newDeptName = $('#newModifyDeptName').val();
    		var item = tree.getSelected();
    		$.ajax({
        		url : '/company/modDeptInfo',
        		type : "POST",
        		data : {deptName:newDeptName,deptId:item.id},
        		success : function(data) {
        			if(data == null || data == '' || data.resultCode == null || data.resultCode != '0') {
        				//alert('出错');
        				return;
        			} else {
        				store.load(null);
        				$.ajax({
        		    		url : '/company/getAllUser',
        		    		type : "POST",
        		    		async: false,
        		    		data : {companyId:headCompanyId},
        		    		success : function(data) {
        		    			if(data == null || data == '') return;
        		    			$('#modify_dept_user_audit').append("<option value='0'>默认</option>");
        		    			$('#dept_user_audit').append("<option value='0'>默认</option>");
        		    			for(var i=0; i<data.length; i++) {
        		    				$('#modify_dept_user_audit').append("<option value='"+data[i].userId+"'>" + data[i].name + "</option>");
        		    				$('#dept_user_audit').append("<option value='"+data[i].userId+"'>" + data[i].name + "</option>");
        		    			}
        		    		}
        		    	});
        			}        			
        		}
        	});
    	})
    	$('#deleteDept').click(function(){
    		var item = tree.getSelected();
    		if(!item.leaf) {
    			BUI.Message.Alert('当前部门具有子部门，请先删除子部门！','warning');
    			return;
    		}
    		BUI.Message.Alert('您确定要删除当前部门嘛？',function() {
    			$.ajax({
            		url : '/company/delDept',
            		type : "POST",
            		data : {companyId:item.companyId,deptId:item.id},
            		success : function(data) {
            			if(data == null || data == '' || data.resultCode == null || data.resultCode != '0') {
            				//alert('出错');
            				return;
            			} else {
            				store.load(null);
            				$.ajax({
            		    		url : '/company/getAllUser',
            		    		type : "POST",
            		    		async: false,
            		    		data : {companyId:headCompanyId},
            		    		success : function(data) {
            		    			if(data == null || data == '') return;
            		    			$('#modify_dept_user_audit').append("<option value='0'>默认</option>");
            		    			$('#dept_user_audit').append("<option value='0'>默认</option>");
            		    			for(var i=0; i<data.length; i++) {
            		    				$('#modify_dept_user_audit').append("<option value='"+data[i].userId+"'>" + data[i].name + "</option>");
            		    				$('#dept_user_audit').append("<option value='"+data[i].userId+"'>" + data[i].name + "</option>");
            		    			}
            		    		}
            		    	});
            			}        			
            		}
            	});
    	    },'warning');
    	})
    	var addUserDialogForm = new Overlay.Dialog({
                title:'添加部门员工',
                width:600,
                height:400,
                contentId:'addDeptUserForm',
                success:function () {
	              	//alert('确认');
	              	this.close();
	            },
                buttons : []
            });
    	var modifyUserDialogForm = new Overlay.Dialog({
            title:'修改部门员工',
            width:600,
            height:450,
            contentId:'modifyDeptUserForm',
            success:function () {
              	//alert('确认');
              	this.close();
            },
            buttons : []
        });
    	var deptUser = new Array();
    	
    	$('#dept_user_modify').click(function(){
    		var dept_user_email = $('#modify_dept_user_email') == null ? "" : $('#modify_dept_user_email').val();
    		var pattern =   /^([\.a-zA-Z0-9_-])+@([a-zA-Z0-9_-])+(\.[a-zA-Z0-9_-])+/;
    		if (!pattern.test(dept_user_email)) {
    			BUI.Message.Alert('电子邮件地址为空或格式不合法，请检查！','warning');
    	        return;  
    	    }
    		if($('#modify_dept_user_name').val() == '' || $('#modify_dept_user_is_admin').val() == '' || 
    				$('#modify_dept_user_dept_id').val() == '' || $('#modify_dept_user_code').val() == '' || 
    				$('#modify_dept_user_level').val() == '') {
    			BUI.Message.Alert('您没有填写所有信息，请检查！','warning');
    			return;
    		}
    		var userDataDetail = {
    				userId:$('#modify_dept_user_email').val(),
    				userName:$('#modify_dept_user_name').val(),
    				charger:$('#modify_dept_user_is_admin option:selected').val(),
    				deptId:$('#modify_dept_user_dept_id').val(),
    				deptName:$('#modify_dept_user_dept_name').val(),
    				userCode:$('#modify_dept_user_code').val(),
    				userLevel:$('#modify_dept_user_level').val(),
    				companyId:tree.getSelected().companyId,
    				msgMail:"",
    				auditUserId:$('#modify_dept_user_audit option:selected').val(),
    				isCompanyAdmin:$('#modify_user_admin option:selected').val()
    				}
    		var fullMask = new Mask.LoadMask({
                el : 'body',
                msg : '正在提交数据。。。'
            });
    		modifyUserDialogForm.close();
    		fullMask.show();
    		$.ajax({
        		url : '/company/modDeptUser',
        		type : "POST",
        		async: false,
        		data : userDataDetail,
        		success : function(data) {
        			if(data == null || data == '' || data.resultCode == null || data.resultCode != '0') {
        				fullMask.hide();
        				BUI.Message.Alert('修改部门员工失败，请稍后重试！','warning');
        				return;
        			}
        			$.ajax({
	            		url : '/company/queryUserByDeptId',
	            		type : "POST",
	            		async: false,
	            		data : {deptId:userDataDetail.deptId, deptName:userDataDetail.deptName},
	            		success : function(data) {
	            			if(data == null || data == '') return;
	            			createDataList(data);
	            		}
            		});
        			fullMask.hide();
        		},
        		error : function() {
        			fullMask.hide();
        			BUI.Message.Alert('修改部门员工失败，请稍后重试！','warning');
        		}
        	});
    	})
    	
    	$('#dept_user_submit').click(function(){
    		var dept_user_email = $('#dept_user_email') == null ? "" : $('#dept_user_email').val();
    		var pattern =   /^([\.a-zA-Z0-9_-])+@([a-zA-Z0-9_-])+(\.[a-zA-Z0-9_-])+/;
    		if (!pattern.test(dept_user_email)) {
    			BUI.Message.Alert('电子邮件地址为空或格式不合法，请检查！','warning');
    	        return;  
    	    }
    		if($('#dept_user_name').val() == '' || $('#dept_user_is_admin').val() == '' || 
    				$('#dept_user_dept_id').val() == '' || $('#dept_user_code').val() == '' || 
    				$('#dept_user_level').val() == '') {
    			BUI.Message.Alert('您没有填写所有信息，请检查！','warning');
    			return;
    		}
    		$('#dept_user_submit').attr("disabled","true");
    		var userDataDetail = {
    				userId:$('#dept_user_email').val(),
    				userName:$('#dept_user_name').val(),
    				charger:$('#dept_user_is_admin option:selected').val(),
    				deptId:$('#dept_user_dept_id').val(),
    				deptName:$('#dept_user_dept_name').val(),
    				userCode:$('#dept_user_code').val(),
    				userLevel:$('#dept_user_level').val(),
    				companyId:tree.getSelected().companyId,
    				msgMail:"",
    				auditUserId:$('#dept_user_audit option:selected').val()
    				}
    		var fullMask = new Mask.LoadMask({
                el : 'body',
                msg : '正在提交数据。。。'
            });
    		addUserDialogForm.close();
    		fullMask.show();
    		$.ajax({
        		url : '/company/addDeptUser',
        		type : "POST",
        		async: false,
        		data : userDataDetail,
        		success : function(data) {
        			if(data.resultCode == '10') {
        				fullMask.hide();
        				BUI.Message.Alert('当前添加员工的电子邮件地址已经被使用，请更换重试！','warning');
        				//addUserDialogForm.show();
        				$('#dept_user_submit').removeAttr("disabled");
        				return;
        			}
        			if(data == null || data == '' || data.resultCode == null || data.resultCode != '0') {
        				fullMask.hide();
        				BUI.Message.Alert('添加部门员工失败，请稍后重试！','warning');
        				$('#dept_user_submit').removeAttr("disabled");
        				return;
        			}
        			$('#dept_user_submit').removeAttr("disabled");
        			//deptUser.push(userDataDetail);
        			//$('#deptUserList').append("<tr><td>"+userDataDetail.userName+"</td><td>"+userDataDetail.deptName+"</td><td>"+userDataDetail.userCode+"</td><td>"+userDataDetail.userLevel+ (userDataDetail.charger == 1 ? "<span class='highlight'>负责人</span>" : "") +"</td><td>"+data.inviteCode+"</td><td><a href=''>修改</a><a href=''>删除</a></td></tr>");
        			$.ajax({
	            		url : '/company/queryUserByDeptId',
	            		type : "POST",
	            		async: false,
	            		data : {deptId:userDataDetail.deptId, deptName:userDataDetail.deptName},
	            		success : function(data) {
	            			if(data == null || data == '') return;
	            			createDataList(data);
	            		}
            		});
        			fullMask.hide();
        		},
        		error : function() {
        			$('#dept_user_submit').removeAttr("disabled");
        			fullMask.hide();
        			BUI.Message.Alert('添加部门员工失败，请稍后重试！','warning');
        		}
        	});
    	})
    	$('#addDeptUser').click(function(){
    		addUserDialogForm.show();
    	})
    	var hasSetCompanyDetailInfo = false;
    	var headCompanyName = '';
    	var headCompanyId = '';
    	var currentSelectOrg = '';
    	var notSetDetailInfoTips = '您当前还没有设置总共司的详细信息，不可以进行任何操作，<a href="/views/webviews/company/organization_information_settings.html">点击这里进行设置<a>'
    	$.ajax({
    		url : '/company/getAllCostCenterEncode',
    		type : "POST",
    		async: false,
    		data : {},
    		success : function(data) {
    			if(data == null || data == '') return;
    			for(var i=0; i<data.length; i++) {
    				$('#oneLevelDeptSelect').append("<option value='"+data[i].encode+"'>"+data[i].name+ (data[i].alias==null || data[i].alias=="" ? "": ("("+data[i].alias+")")) + "</option>");
    			}
    		}
    	});
    	$.ajax({
    		url : '/company/getAllUser',
    		type : "POST",
    		async: false,
    		data : {companyId:headCompanyId},
    		success : function(data) {
    			if(data == null || data == '') return;
    			$('#modify_dept_user_audit').append("<option value='0'>默认</option>");
    			$('#dept_user_audit').append("<option value='0'>默认</option>");
    			for(var i=0; i<data.length; i++) {
    				$('#modify_dept_user_audit').append("<option value='"+data[i].userId+"'>" + data[i].userName + "</option>");
    				$('#dept_user_audit').append("<option value='"+data[i].userId+"'>" + data[i].userName + "</option>");
    			}
    		}
    	});
    	//XiaoMing add weixin invite code
    	$.ajax({
    		url:'/company/getCompanyWeixinInviteCode',
    		type : "POST",
    		data : {},
    	    success : function(data) {
    	    	if (data != null && data.error_code == 0) {
    	    		$('#org_weixin_code').html(data.user_invite_code);
    	    	}
    	    }    		
    	})
    	$.ajax({
    		url : '/company/getCompanyDetailInfo',
    		type : "POST",
    		data : {},
    		async: false,
    		success : function(data) {
    			if(data == null || data == '') {
    				$('#currentOpeTips').html(notSetDetailInfoTips);
    				$('#currentOpeTips').show();
    				return;
    			}
    			$('#currentOpeTips').hide();
    			hasSetCompanyDetailInfo = true;
    			$('#company_name').html(data.company_name);
    			headCompanyName = data.company_name;
    			headCompanyId = data.company_id;
    			currentSelectOrg = headCompanyId;
    			$('#parent_company').html(data.parent_company_name == null || data.parent_company_name == '' ? '无' : data.parent_company_name);
    			$('#org_name').html(data.company_name);
    			$('#org_code').html(data.org_code);
    			$('#org_type').html('总公司');
    			$('#addOneLevelDeptOrSubCompany').show();
    			$('#deleteSubCompany').addClass("disabled");
    			$('#currentSelectSubComapny').val(headCompanyName);
    			//数据缓冲类
    	        store = new Data.TreeStore({
    	            root : {
    	              id : headCompanyId,
    	              text : headCompanyName
    	            },
    	            url : '/company/getOrgStructureData',
    	            autoLoad : true
    	          });
    	          
    	        tree = new Tree.TreeList({
    	          render : '#t1',
    	          showLine : true,
    	          height:300,
    	          store : store,
    	          showRoot : true
    	        });
    	        tree.render();
    	        var item = tree.getItem(headCompanyId);
    	        tree.setSelected(item);
    	        tree.on('itemclick',function(ev){
    	        	currentSelectOrg = ev.item.id;
    	        	if(ev.item.typeIsDept) {
    	        		$('#addDeptUser').removeClass('disabled');
    	        		$('#addOneLevelDeptOrSubCompany').hide();
    	        		$('#addSubDept').show();
    	        		$('#currentSelectDept').val(ev.item.text);
    	        		$('#dept_user_dept_name').val(ev.item.text);
    	        		$('#dept_user_dept_id').val(ev.item.id);
    	        		$('#deptUserList').html("");
    	        		$.ajax({
    	            		url : '/company/queryUserByDeptId',
    	            		type : "POST",
    	            		async: false,
    	            		data : {deptId:ev.item.id, deptName:ev.item.text},
    	            		success : function(data) {
    	            			if(data == null || data == '') return;
    	            			createDataList(data);
    	            		}
    	            	});
    	        	} else {
    	        		$('#addDeptUser').addClass('disabled');
    	        		$('#addOneLevelDeptOrSubCompany').show();
    	        		$('#addSubDept').hide();
    	        	}
    	        	if(ev.item.typeIsSubCompany) {
    	        		$('#company_name').html(ev.item.text);
    	        		$('#parent_company').html(headCompanyName);
    	        		$('#org_type').html('分公司');
    	        		$('#org_name').html(ev.item.text);
    	        		$('#deleteSubCompany').removeClass("disabled");
    	        		$('#addNewSubComapny').addClass("disabled");
    	        		$('#currentSelectSubComapny').val(ev.item.text);
    	        	} else {
    	        		$('#company_name').html(headCompanyName);
    	        		$('#org_name').html(ev.item.text);
    	        		$('#parent_company').html('无');
    	        		$('#org_type').html('总公司');
    	        	}
    	        	if(currentSelectOrg == headCompanyId) {
    	        		$('#deleteSubCompany').addClass("disabled");
    	        		$('#addNewSubComapny').removeClass("disabled");
    	        		$('#currentSelectSubComapny').val(ev.item.text);
    	        	}
    	        	//alert(node);
    	        	//var subNode = store.add({id : '205',text: '测试部门'}, node);
    	        	//tree.render();
    	          	//var item = ev.item;
    	          	//$('.log').text(item.text);
    	        });
    		}
    	});
    	
    	function createDataList(data) {
    		$('#deptUserList').html("");
    		data.sort(function(a,b){return a.createDate<b.createDate?1:-1});
    		deptUser = data;
    		for(var i=0; i<deptUser.length; i++) {
    			var container = $('#deptUserList');
    			var tr = $("<tr></tr>");
    			var td1 = $("<td>"+deptUser[i].userName+"</td><td>"+deptUser[i].deptName+"</td><td>"+deptUser[i].userCode+"</td><td>"+deptUser[i].userLevel+ (deptUser[i].charger == 1 ? "<span class='highlight'>负责人</span>" : "") +"</td><td>"+(deptUser[i].auditUserName == null || deptUser[i].auditUserName == "" ? "默认":deptUser[i].auditUserName )+"</td><td>"+deptUser[i].inviteCode+"</td><td>"+(deptUser[i].userType == "5" ? "否" : "是")+"</td>");
    			var td2 = $("<td></td>");
    			var a1 = $("<a href='javascript:void(0)'>修改</a>");
    			var a2 = $("<a href='javascript:void(0)'>删除</a>");
				a1.attr("user_id", deptUser[i].userId);
			    a1.click(function(event) {
			    	for(var i=0; i<deptUser.length; i++) {
			    		if(deptUser[i].userId === $(this).attr("user_id")) {
			    			$('#modify_dept_user_email').val(deptUser[i].userId);
		    				$('#modify_dept_user_name').val(deptUser[i].userName);
		    				$('#modify_dept_user_is_admin option[value="'+deptUser[i].charger+'"]').attr("selected", true);  
		    				$('#modify_dept_user_dept_id').val(deptUser[i].deptId);
		    				$('#modify_dept_user_dept_name').val(deptUser[i].deptName);
		    				$('#modify_dept_user_code').val(deptUser[i].inviteCode);
		    				$('#modify_dept_user_level').val(deptUser[i].userLevel);
		    				$('#modify_user_admin option[value="'+(deptUser[i].userType==5?0:1)+'"]').attr("selected", true);
		    				$('#modify_dept_user_audit option[value="'+deptUser[i].auditUserId+'"]').attr("selected", true);
		    				modifyUserDialogForm.show();		
			    		}
			    	}
			    });
			    a2.attr("user_id", deptUser[i].userId);
			    a2.click(function(event) {
			    	var userId = $(this).attr("user_id");
		    		BUI.Message.Alert('您确定要删除当前员工吗？',function() {
		    			$.ajax({
		            		url : '/company/delDeptUser',
		            		type : "POST",
		            		data : {userId:userId,deptId:tree.getSelected().id},
		            		success : function(data) {
		            			$.ajax({
		                    		url : '/company/queryUserByDeptId',
		                    		type : "POST",
		                    		async: false,
		                    		data : {deptId:tree.getSelected().id, deptName:tree.getSelected().text},
		                    		success : function(data) {
		                    			if(data == null || data == '') return;
		                    			createDataList(data);
		                    		}
		                    	});   			
		            		}
		            	});
		    	    },'warning');
			    });
			    td2.append(a1);
    			td2.append(a2);
			    tr.append(td1);
			    tr.append(td2);
			    tr.appendTo(container);
    		}
    	}
    	
      });
	</script>
</body>
</html>